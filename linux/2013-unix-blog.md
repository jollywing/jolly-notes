

# 2013年的Linux Blog #

## Linux声音系统 ##
> TAG: linux, alsa, oss, pulseaudio, esd, aRts  
> DATE: 2013-08-13

Linux声音系统有些混乱，它有三套音频驱动:
*OSS* (Open Sound System),
商业版的*OSS*，和*ALSA* (Advanced Linux Sound Architechture)。
所以底层驱动有*OSS*和*ALSA*两套API。

### 一、声卡的工作原理 ###
音频驱动的主要作用是驱动声卡工作，所以也叫声卡驱动。
声卡的主要作用是完成数模转换。
当电脑播放声音时，将数字数据送到声卡，由声卡转换成模拟数据给扬声器等外放设备。
当录音时，声卡将从麦克风送来的模拟数据采样成数字数据，送给计算机处理。

### 二、Linux音频驱动 ###
早期的Linux音频驱动是*OSS* (Open Sound System)，
但*ALSA* (Advanced Linux Sound Architechture)后来居上，
大有完全取代*OSS*的趋势。

Linux都是通过设备文件访问外部设备，
*ALSA*和*OSS*有不同的设备文件。
(其中 PCM 是 Pulse-code modulation，脉冲编码调制，是声卡的核心设备，
能完成 playback 和 capture 两大任务。)

    +----------+--------------+--------------------+---------+
    |设备类型  |    OSS       |  ALSA              | 备注    |
    +----------+--------------+--------------------+---------+
    |声音采样  |   /dev/dsp0  | /dev/snd/pcmC0D0   |         |
    +----------+--------------+--------------------+---------+
    | 混音器   |  /dev/mixer0 | /dev/snd/mixerC0D0 | 控制音量|
    +----------+--------------+--------------------+---------+
    |高层音序器|  /dev/music0 |    N/A             | MIDI支持|
    +----------+--------------+--------------------+---------+
    |低层音序器|  /dev/midi0  |    N/A             | MIDI支持|
    +----------+--------------+--------------------+---------+
    |声音状态  |  /dev/sndstat|    N/A             |         |
    +----------+--------------+--------------------+---------+
    |控制文件  |   N/A        | /dev/snd/controlC0 |         |
    +----------+--------------+--------------------+---------+
     
     
*ALSA*提供了和*OSS*不同的API，因此如果你使用*ALSA*做音频驱动，
一些通过*OSS*操作声音的程序将不能正常发声。

为了解决这一问题，*ALSA*提供了兼容*OSS*的库，
因此，如果你使用 *ALSA* 驱动声卡，也安装了兼容*OSS*的库，
那些使用*OSS* API的程序也能正常工作。

### 三、应用程序和声卡驱动的交互方式 ###

#### 直接和底层声音驱动打交道 ####
有一些应用程序直接和最底层的声音驱动（*OSS*或*ALSA*）打交道，
程序内部直接调用 *OSS* 或 *ALSA* 的API。

#### 通过声音服务器 ####
声音服务器介于应用程序和声卡驱动之间。
当不同的应用调用声音服务器的API来播放声音时，它们把音频数据送到服务器，
服务器将一个以上的播放请求混音后，再发送给底层的声卡驱动(*ALSA*或*OSS*)。
由*ALSA*或*OSS*来驱动声卡播放混音后的数据。
基于*ESD*开发音频程序的好处有：（1）简化开发。（2）即使底层驱动不支持多线程，
通过声音服务器也能实现多个应用程序同时发声。（3）有更好的音效。

1. *ESD*  
   *ESD* 一直是 Gnome 桌面环境的声音服务器，
   Gnome 应用多是通过 *ESD* 处理声音的。
2. *aRts*  
   和 *ESD* 对应，*aRts* 是 KDE 桌面环境的声音服务器，
   底层通过 *ALSA* 驱动声卡。KDE 应用多通过 *aRts* 处理声音。
3. *PulseAudio*  
   *PulseAudio*是新一代声音服务器，能提供更好的音效，
   已经有越来越多的应用通过*PulseAudio*处理声音。
   为了让使用*ESD*的程序能继续在 *PulseAudio* 上工作，
   *PulseAudio* 提供了 *ESD* 的兼容层。
   Gnome 未来将采用*PulseAudio*取代*ESD*。

#### 通过其它库 ####
除了声音服务器，为了简化开发，还出现了其它的一些声音库。
这些声音库有的和声音服务器打交道，有的直接和最底层的声音驱动（*OSS*或*ALSA*）打交道。
比如游戏程序使用的*SDL*库，就是直接和声音驱动打交道。

### 四、总结 ###
Linux从应用程序到声音驱动的结构如下图所示。

       +-------+  +------+     +-----+  +-----+ +----+
       | Apps  |  | Apps |     |Apps |  |Apps | |Apps|
       +---+---+  +---+--+     +--+--+  +--+--+ +-+--+
           |          |           |        |      |
       +---+---+  +---+------+  +-+--+  +--+--+   |
       | ESD   |  |PulseAudio|  |aRts|  |Other|   |
       | Gnome |  |ESD compat|  |KDE |  | SDL |   |
       +---+---+  +----+-----+  +-+--+  +--+--+   |
           |           |          |        |      |
       +---+-----------+----------+--------+------+---+
       | ALSA (Advanced Linux Sound Architechture)    |
       |    OSS (Open Sound System)                   |
       +----------------------------------------------+

## 自制原声大碟 ##
> TAG: ffmpeg, mp3  
> DATE: 2013-11-11 Mon

### 一、动机 ###

为了达到看懂无字幕大片的目标，必须要不断地练习。

听了近10遍 `The sorrows of young werther` 的有声书，觉得语速有些慢了。
决定找部电影练习，但电影原声大碟下载有些麻烦，不如自己动手制作。
有利器 `FFMPEG` 在手，怕什么呢？

### 二、FFMPEG的优缺点 ###

FFMPEG是一个能和经典播放器 MPLAYER 的媲美的多媒体开源项目，主页在 <http://www.ffmpeg.org/>.

优点：

- 功能强大：可以提取视频、音频，分割多媒体文件，转码，调整分辨率等等。支持的编码格式很全。
- 灵活：因为是命令行工具，可以通过脚本调用，从而使多媒体处理任务自动化。
- 高效：用用就知道了。

缺点：

- 命令行界面，选项繁多，令人望而生畏。

其实这不成问题，因为使用 FFMPEG 的人太多了，分享经验的人也多，因而网上有很多现成的经验可以利用。
你想用FFMPEG做什么，上网搜一下，就有很多结果，照着做就行了。
我就是这么干的，嘿嘿。

### 三、制作过程 ###

1. 首先选一部值得听的电影，所谓值得听，就是对话要比较密集啊，而且语速对自己来说比较适合。
   我选了一部经典：肖申克的救赎。

2. 提取音频：电影是rmvb格式，目标是提取其音频，存为 `shawshank.mp3`.

        ffmpeg -i 肖申克的救赎.rmvb
        ffmpeg -codecs |grep mp3
        ffmpeg -codecs |grep cook

        ffmpeg -i 肖申克的救赎.rmvb -f mp3 -vn shawshank.mp3

   其中 `-i 肖申克的救赎.rmvb` 指定要处理的源文件；
   `-f mp3` 表示用 mp3 的格式编码要生成的文件；
   `-vn` 表示 video no, 即不要视频，只要音频；
   `shawshank.mp3` 就是要生成的目标文件名。

2. `肖申克的救赎` 接近两个半小时的长度，存成一个音频文件练听力并不是很方便。
   接下来我把它分成4段，每段半个多小时。

   先截取第一段：
    
        ffmpeg -i shawshank.mp3 -ss 00:00:15 -t 00:33:42 -acodec copy shawshank-01.mp3

    `-i shawshank.mp3` 指明处理的源文件；
    `-ss 00:00:15` 指明要截取音频的开始时间（我从15秒开始，是为了跳过电影片头）；
    `-t 00:33:42` 指明要截取音频的结束时间；
    `-acodec copy` 表示生成的目标文件和源文件的编码相同，这个是必要的，如果不要这个选项，ffmpeg会重新编码，比较花时间而且没必要，有了这个选项，一眨眼就完成了；
    `shawshank-01.mp3` 指明生成的目标文件。

    这样我们就从 shawshank.mp3 截取了从15秒开始到33分42秒结束的一段音频。
    其实用这个方法自制彩铃也很不错的。

    剩下几段的制作和第一段类似。最后一段要截取到片尾，就不用指明结束时间了。
    
        ffmpeg -i shawshank.mp3 -ss 00:33:42 -t 01:10:23 -acodec copy shawshank-02.mp3
        ffmpeg -i shawshank.mp3 -ss 01:10:23 -t 01:45:11 -acodec copy shawshank-03.mp3
        ffmpeg -i shawshank.mp3 -ss 01:45:11 -acodec copy shawshank-04.mp3

    至此我们的原声大碟制作完成了。
    
    需要注意的是，截取之前用播放器看一下，记录一下截取的起止时间，免得在对话中间截断。
    
### 四、后记 ###

好了，听力资料制作好了，接下来就是每天听一段。

听之前最好看一遍电影，对着英文字幕把生词记下来，都消化掉。

然后就是，在听的同时要跟着说，这样比较有效果，也不容易在听的时候走神。
